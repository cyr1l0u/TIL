# 머신러닝 프로젝트 처음 시작하기

## 머신러닝을 어떻게 동작하는가

지도학습, 비지도 학습, 강화학습 등이 있다.

지도학습은 학습단계와 예측단계로 구성된다.

## 머신러닝 프로젝트의 과정

머신러닝으로 성공한 사례를 볼 때는 다음 세가지 질문을 살펴보자.

* 어떤 알고리즘을 사용하였는가?
* 어떤 데이터를 특징으로 사용하였는가?
* 머신러닝을 어떻게 통합하였는가?

머신러닝으로 해결 가능한 것과 그렇지 않을 것을 구분하는 것이 중요하다.

> 데이터 분석의 80%는 전처리

### 문제정의하기

풀려고 하는 문제를 정의해야한다. 분석하는 과정에서 KPI(Key Performance Indicator, 핵심성과지표)가 발견되기 마련이다.

이와 관련해서는 `린 스타트업`과 `린 분석` 두 권의 책을 참조하자.

가설을 세우고 검증하는 방법은 쿡패드 개발자 블로그 [가설 검증과 샘플 크기의 기초](http://techlife.cookpad.com/entry/2016/09/26/111601)를 참조하자. 일본어다. -_-

### 머신러닝을 사용하지 않는 방법 검토하기

> 머신러닝은 기술부채 중 이자율이 매우 높은 신용카드다. - Sculley et al., 2014

머신러닝을 사용하는 시스템에는 다음과 같은 어려움이 있을 수 있다.

* 확률적인 부분으로 인해 자동 테스트가 어렵다.
* 오래 운용하면 사용자 경향이 변해서 입력 경향도 바뀐다.
* 처리 파이프가 복잡해진다.
* 데이터 의존관계가 복잡해진다.
* 실험 코드 혹은 실험 파라미터가 포함되기 쉽다.
* 개발 시스템과 운영시스템 간의 언어/프레임워크가 파편화된다.

같은 단어가 트렌드가 바뀌면서 호오가 바뀌기도 한다. 혹은 자바와 같은 단어의 뜻이 지역명, 커피, 프로그래밍 언어와 같이 주요 의미가 바뀌기도 한다. 또한 난수를 이용하기 때문에 결과가 비결정적이고, 워낙 큰 데이터셋을 다루기 때문에, 생각치 못한 예측결과를 내보낼 수 있다. 따라서 사후에 시스템에 개입할 여지를 남겨두어야 한다.

따라서, 머신러닝이 적합한 비지니스 문제는 다음과 같은 조건을 가져야 한다.

* 대량의 데이터에서 고속으로 안정적인 판단을 요구받는다.
* 예측 결과에 일정 수준의 오류가 용인된다.

이러한 조건이 갖추어지면, MVP(Minimum Viable Product, 최소기능제품)를 만들어 본다. "린 스타트업"에서 다루는 주제로 고객가치를 창출할 수 있는 최소한의 제품을 의미한다.

머신러닝은 문제 설정에서 가설 검증에 이르는 사이클이 일반적인 개발주기에 비해서 긴 편이므로, 고객 니즈 및 개념 정리가 명확히 되었는지 미리 살펴볼 필요가 있다.

### 시스템 설계하기

문제 정의와 MVP 검증이 끝나면, 머신러닝 시스템을 설계해야 한다. 중요한 질문은 다음과 같다.

* 예측 결과를 어떻게 이용할 것인가?
* 예측 오류의 영향을 어떻게 흡수할 것인가?

예측 결과를 이용하는 방법은 예측 결과를 배치로 처리하여 데이터베이스에 저장하는 방식과 사용자 액션마다 비동기적으로 처리하는 방법이 있다.

오류에 대처하기 위해, 예측 결과를 사람이 직접 확인 후 시스템에 적용되도록 하는 방식을 생각할 수 있다. 그 피해가 크지않다면, 직접 시스템에 적용할 수도 있다.

실제 작업(데이터 수집, 모델 작성, 시스템 구축)에 들어가면, 목표 성능과 포기 지점을 설정해야 한다. 그렇지 않으면, 끝없이 개선하는 늪에 빠지거나 근자감에 빠지기 쉽다.

### 알고리즘 선택하기

데이터 특성을 모른다면, 군집화 같은 비지도 학습이나, 스캐터플롯 매트릭스 등으로 데이터를 탐색할 수 있다.

데이터 양에 기초하여 온라인 학습과 배치학습 중에 어느 쪽이 더 적합한지 판단할 수 있다.

### 특성, 레이블, 로그 설계하기

특성은 모델에 입력되는 정보이다. 수치화된 자료를 이용하나, 범주형 변수는 더미 변수를 이용하여 수치화한다. 사이킷런의 `LabelEncoder`나 `OneHotEncoder`을 이용할 수 있다.

고전 머신러닝에서는 적합한 특성을 선택하는 것이 모델링의 핵심이었다. 따라서 도메인 전문가의 경험적 지식이 중요하다. 이 경우 불필요한 데이터는 나중에 제거할 수는 있지만, 필요한 정보를 나중에 추가하는 것은 매우 어렵다.

특성이 준비되면, 입력 데이터로 쓸 정답 데이터가 필요하다.

지도학습에서는 품질이 높은 정답 레이블을 확보하는 것이 중요하다.

서버의 로그에서 정답 데이터를 찾기도 한다.

### 데이터 전처리

전처리는 문제와 데이터에 따라 달라지나, 기본적으로 불필요한 정보를 발라내고, 데이터를 머신러닝에 이용할 수 있는 형태로 만드는 것이 주된 일이다. 관개형 데이터베이스가 이상적인 형태이나, 로그 같은 경우는 특정한 형식에 맞추어 변환할 필요가 있고, 수치 데이터는 누락값이나 이상치를 처리해야 한다. 값의 변동폭이 크게 차이날 경우에는 정규화같은 과정이 필요하다. 텍스트 데이터는 빈도를 세거나, 빈도가 적은 단어를 입력 자료에서 제외하기도 한다. 범주형 변수를 더미 변수로 바꾸는 작업 역시 전처리의 주요한 작업 중 하나이다.

### 학습 및 파라미터 튜닝

우선 사람이 직접 부여한 정답이나 규칙 기반 예측보다 나은 성능을 목표로 한다.

첫 단계로 로지스틱 회귀와 같은 간단한 모델을 만들어본다. 대부분의 경우 데이터 누락과 같이 데이터 자체에 버그가 잠재되어 있을 수 있다.

첫번째 결과가 너무 잘 맞으면(99.9% 같이), 어딘가 실수가 있었는지 의심해 봐야한다. 과적합 가능성이 높고, 훈련 데이터가 테스트 데이터에 일부 섞이면서 데이터 유출이 생겨서일 수 있다.

과적합은 훈련 데이터의 예측 성능은 높지만, 처음보는 데이터에 대한 예측은 훨씬 뒤쳐지는 현상을 보인다. 반대로, 처음 보는 데이터를 잘 처리하는 모델은 일반화 성능이 높다라고 한다.

데이터 유출(data leakage)는 캐글에서 진행한 "암 예측 콘테스트"의 예로 살펴보자. 전립선 수술을 받았는지 여부의 필드가 포암되어 있었는데, 이 정보를 사용한 예측 모델은 성능이 매우 좋았지만, 해당 필드 자체가 "전림선 암을 앓은 환자가 암을 진단받은 후 수술을 받았다"라는 의미가 되므로, 암 진단을 새로이 예측하는 모델을 무의미하게 만들어버렸다. 시계열 데이터를 사용하는 경우, 검증 데이터를 무작위로 분할하는 과정에서 학습 데이터가 테스트 데이터에 포함되는 경우가 종종 발생한다.

이러한 점에 주의하여, 학습 및 파라미터 튜닝을 하되, 오답 사례는 원인을 살펴보는 것이 중요하다.

과적합을 방지하는 방법은 1) 교차검증을 통한 파라미터 튜닝, 규제화, 학습곡선 살펴보기 등이 있다. 교차 검증은 훈련 데이터와 검증 데이터를 분할하는 과정에서 서로 다른 셋을 선택하도록 하는 과정이다. 예를 들어, 10개의 데이터셋으로 나누고, 9개는 학습용, 1개는 검증용으로 쓰되, 반복적으로 조합을 바꾸어 테스트하게 된다. 사이킷런에서는 `cross_val_score()` 함수와 `GridSearchCV` 클래스를 제공한다.

실무에서는 한 그룹정도의 데이터셋을 미리 빼두어, 이를 테스트 데이터라고 부르고, 나머지 교차 검증용 자료는 개발 데이터라고 부르기도 한다.

두번째 방법으로 규제화(regularization)가 사용되기도 한다. 규제화는 모든 데이터를 정확히 분류하는 대신, 약간 잘못 분류하더라도, 새로운 데이터를 적절히 처리하도록 하는 방법이다.

학습곡선(learning curve)는 데이터 규모나 학습 반복 횟수에 따라 손실값의 추이를 나타낸 그래프이다. 이 그래프를 참조하여 과적합 여부를 판별한다.

### 시스템에 통합하기

이렇게 완성된 러닝머신 모델은 시스템에 통합하는 일만 남았다. 이때 주의할 점은 예측성능과 비지니스 성과를 모니터링 해야 한다. 예측 성능 모니터링은 미리 사람이 작성한 데이터와 정답의 쌍으로 이루어진 데이터셋을 이용하는데, 이러한 데이터셋을 황금기준(gold standard 또는 황금표준)이라고 한다.

통합된 이후에는 비지니스 지표 개선을 잘 살펴보아야 한다. 즉, KPI를 개선해야 한다. 모델에 빠져지내면 안된다. 시스템 통합이 끝이 아니라, 꾸준히 개선해 나가야 할 일인 것이다.

## 운영시스템에서 발생하는 머신러닝 문제 대처법

### 사람이 정한 황금기준을 사용하여 예측성능 모니터링

머신러닝은 확률적인 부분이 있어서 예측 결과를 자동화하여 검증하기 어려우나, 미리 확보한 데이터와 정답 셋이 있으면 이를 이용하여 예측 성능을 측정하고, 변화 추이를 모니터링할 수 있다. 예측성능의 임계치를 설정해두면, 입력 경향 변화를 감지할 수 있다.

### 알고리즘에 대한 A/B 테스트

예측 모델을 이용하여 운영하다 보면, 한가지 알고리즘으로는 금세 한계에 봉착한다. 여러 예측 모형을 모듈화해두고, 병렬로 바꾸어가며 A/B 테스트를 하여 비교할 수 있다.

### 모델 버전관리를 통한 자유로운 롤백

머신러닝 시스템을 장기간 운영하다보면, 원인을 알 수 없이 성능이 떨어질 수 있다. 입력 데이터가 바뀌었을 수도 있고, 처리 과정에서 예상치 못한 오류가 발생했을 수도 있다. 이중 모델 갱신이 원인일 가능성을 배제하기 위해서는, 이전버전으로 손쉽게 롤백할 수 있어야 한다. 소스코드, 모델, 데이터를 모두 버전관리하는 것이 가장 이상적이다.

모델 버전관리와 함께, 데이터에 대한 설명도 문서화해주면 도움이 된다.
